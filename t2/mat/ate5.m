R1 = 1049.1247892548885
R2 = 2057.0374101847353
R3 = 3145.8663326009977
R4 = 4120.366732089611
R5 = 3092.7962413464845
R6 = 2078.6230379467447
R7 = 1047.2117985101572
Vs = 5.1341639347415216
Kb = 0.007269088977559832
Kd = 8043.058819127204

A = [1,0,0,0,0,0,0 ; -(1/R1),(1/R3)+(1/R2)+(1/R1),-(1/R2),-(1/R3),0,0,0 ; 0,(Kb+(1/R2)),(-1/R2),(-Kb),0,0,0 ; 0,(1/R3),0,(-(1/R4)-(1/R5)-(1/R3)),(1/R5),(1/R7),-(1/R7) ; 0,(-Kb),0,(Kb+(1/R5)),(-1/R5),0,0 ; 0,0,0,0,0,((1/R6)+(1/R7)),(-1/R7);0,0,0,1,0,Kd/R6,-1];

B = inv(A);

E = [Vs;0;0;0;0;0;0];

D = B*E;

H = [-(1/R1),0, -(1/R4),0, -(1/R6),0,0,0,0;-(1/R1)-(1/R2)-(1/R3), 1/R2,1/R3,0,0,0,0,0,0; (-Kb -(1/R2)),1/R2,Kb,0,0,0,0,0,0;0,0,1,0,Kd/R6,-1,0,0,0;0,0,0,0,(1/R6+1/R7),-(1/R7),0,0,0;0,0,0,1,0,-1,0,0,0;Kb,0,-Kb,0,0,0,0,-1,0;0,0,1/R5,-(1/R5),0,0,-1,0,0;0,0,0,0,0,0,-1,1,-1];

Vx = D(5)-D(7)

Z= [0;0;0;0;0;Vx;0;0;0];

T = inv(H);

X = T*Z;

Req = (X(4)-X(6))/X(9);
sprintf("%.6f\n",X)

C = 1.031099e-6;

Tau = Req*C;

t = 0:2e-6:20e-3;

v6n = X(4)*exp(-t/Tau);

v8n = X(6)*exp(-t/Tau);

f1 = figure();

plot(t*1000,v6n,"b");

xlabel("t[ms]");

ylabel("v6n[V]");

print(f1,"natural_solution.eps","-depsc");


%forced solution

w = 2*pi*1000;
Zc = 1/(j*w*C);

G = [1,0,0,0,0,0,0; 1/R1, -(1/R1)-(1/R2)-(1/R3), 1/R2, 1/R3,0,0,0; 0, (-(1/R2)-Kb), 1/R2, Kb, 0,0,0; 0, 1/R3,0,(-(1/R5)-(1/R3)-(1/R4)), (1/R5 +1/Zc), (1/R7),(-(1/R7)-(1/Zc)); 0,Kb,0,(-(1/R5)-Kb),(1/R5+1/Zc),0,-(1/Zc);0,0,0,0,0,(-(1/R6)-(1/R7)),1/R7;0,0,0,1,0,Kd/R6,-1];
Q = [1;0;0;0;0;0;0];
L = inv(G);
P = L*Q;
sprintf("%.6f\n",P)

Gain = abs(P(5));
Phase = angle(P(5));

t = 0:2e-6:20e-3;
v6f = Gain*sin(w*t+Phase);
f2 = figure();
plot(t*1000,v6f,"g");
xlabel("t[ms]");
ylabel("v6f[V]");
title("Forced Solution");
print(f2,"forced_solution.eps","-depsc");


%total solution

t = -5e-3:2e-6:20e-3;
moment1 = t<0; moment2 = t>=0;
V6(moment1) = D(5);
V6(moment2) = X(4)*exp((-t(moment2))/Tau) + Gain*sin(w*(t(moment2))+Phase);
vs(moment1) = Vs;
vs(moment2) = sin(w*(t(moment2)));
f5 = figure();
plot(t*1000,V6,"k",t*1000,vs,"m");
	
	
	

